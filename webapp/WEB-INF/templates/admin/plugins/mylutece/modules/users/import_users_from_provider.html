<@pageContainer>
    <@pageColumn>
        <@pageHeader title='#i18n{module.mylutece.users.importUsers.pageTitle}' />
        <@messages infos=infos />
        <@messages errors=errors />
        <@row>
            <@columns sm=12 md=4 lg=3>
                <@tform action='jsp/admin/plugins/mylutece/modules/users/ManageMyLuteceSearchUsers.jsp' method='post' boxed=true>
                    <@formGroup labelFor='search_lastName' labelKey='#i18n{module.mylutece.users.label.lastName}'>
                        <@input type='text' name='search_lastName' />
                    </@formGroup>
                    <@formGroup labelFor='search_givenName' labelKey='#i18n{module.mylutece.users.label.givenName}'>
                        <@input type='text' name='search_givenName' />
                    </@formGroup>
                    <@formGroup labelFor='search_email' labelKey='#i18n{module.mylutece.users.label.email}'>
                        <@input type='text' name='search_email' />
                    </@formGroup>
                    <#if attribute_list??>
                        <#list attribute_list as mylutece_attribute>
                            <#assign provider_attribute_id=getSelected(mylutece_attribute.idAttribute)>
                            <#if provider_attribute_id?has_content>
                                <@formGroup labelFor='provider_attribute_${provider_attribute_id}' labelKey='${mylutece_attribute.title}'>
                                    <@input type='text' name='provider_attribute_${provider_attribute_id}' />
                                </@formGroup>
                            </#if>
                        </#list>
                    </#if>
                    <@formGroup>
                        <@button type='submit' name='action_searchUsersFromProvider' buttonIcon='search' title='#i18n{module.mylutece.users.buttonSearch}' color='primary' />
                    </@formGroup>
                </@tform>
            </@columns>
            <@columns sm=12 md=8 lg=9>
                <@table headBody=true>
                    <@tr>
                        <@th>#i18n{module.mylutece.users.column.login}</@th>
                        <@th>#i18n{module.mylutece.users.column.lastName}</@th>
                        <@th>#i18n{module.mylutece.users.column.givenName}</@th>
                        <@th>#i18n{module.mylutece.users.column.email}</@th>
                        <@th>#i18n{portal.util.labelActions}</@th>
                    </@tr>
                    <@tableHeadBodySeparator />
                    <#if mylutece_search_user_list??>
                        <#list mylutece_search_user_list as searchUser>
                            <@tr>
                                <@td>${searchUser.login}</@td>
                                <@td>${searchUser.lastName}</@td>
                                <@td>${searchUser.givenName}</@td>
                                <@td>${searchUser.email}</@td>
                                <@td>
                                    <@tform method='post' action='jsp/admin/plugins/mylutece/modules/users/ManageMyLuteceSearchUsers.jsp'>
                                        <@input type='hidden' name='plugin_name' value='${plugin_name!""}' />
                                        <@input type='hidden' name='login' value='${searchUser.login}' />
                                        <@input type='hidden' name='email' value='${searchUser.email}' />
                                        <@input type='hidden' name='last_name' value='${searchUser.lastName}' />
                                        <@input type='hidden' name='given_name' value='${searchUser.givenName}' />
                                        <@input type='hidden' name='provider_user_id' value='${searchUser.providerUserId}' />
                                        <@input type='hidden' name='import_from_provider' value='true' />
                                        <#if searchUser.attributes??>
                                            <#list searchUser.attributes as attribute>
                                                <#if attribute.code??>
                                                    <#assign mylutece_attribute_id=getIdMyLuteceAttribute(attribute.name)>
                                                    <@input type='hidden' name='attribute_${mylutece_attribute_id}' value='${attribute.code}' />
                                                </#if>
                                            </#list>
                                        </#if>
                                        <@button type='submit' title='#i18n{module.mylutece.users.importUsers.buttonImport}' buttonIcon='upload' size='sm' name='action_createMyLuteceSearchUser' color='primary' hideTitle=['all'] />
                                    </@tform>
                                </@td>
                            </@tr>
                        </#list>
                    </#if>
                </@table>
            </@columns>
        </@row>
    </@pageColumn>
</@pageContainer>

<#function getSelected idMyLuteceAttribute>
    <#if attribute_mapping_list?has_content>
        <#list attribute_mapping_list as attribute_mapping>
            <#if attribute_mapping.id == idMyLuteceAttribute>
                <#return attribute_mapping.idProviderAttribute>
            </#if>
        </#list>
    </#if>
    <#return "">
</#function>

<#function getIdMyLuteceAttribute idProviderAttribute>
    <#if attribute_mapping_list?has_content>
        <#list attribute_mapping_list as attribute_mapping>
            <#if attribute_mapping.idProviderAttribute == idProviderAttribute>
                <#return attribute_mapping.id>
            </#if>
        </#list>
    </#if>
    <#return "">
</#function>
